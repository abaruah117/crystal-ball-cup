<!DOCTYPE html>
<html>

<head>
    <title>2025 Crystal Ball Cup</title>
    <script src="https://cdn.plot.ly/plotly-3.0.3.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            font-variation-settings: 'wdth' 55;
        }

        main {
            max-width: 50rem;
            padding: 2rem;
            margin: auto;
        }
    </style>
</head>

<body>
    <main>
        <h1>2025 Crystal Ball Cup</h1>
        <select id="question-dropdown"></select>
        <select id="email-dropdown"></select>
        <div id="question-description" style="margin-top: 1rem; font-style: italic;"></div>
        <div id="plot"></div>
    </main>

    <script>
        Promise.all([
            d3.json('events.json'),
            d3.csv('responses.csv')
        ]).then(([events, responses]) => {
            const allEvents = [{ id: 'all', short: 'All' }, ...events];

            const questionDropdown = d3.select('#question-dropdown');
            const emailDropdown = d3.select('#email-dropdown');

            questionDropdown.selectAll('option')
                .data(allEvents)
                .enter()
                .append('option')
                .attr('value', d => d.id)
                .text(d => d.short);

            const usernames = ['All', ...responses.map(r => r.Username)];
            emailDropdown.selectAll('option')
                .data(usernames)
                .enter()
                .append('option')
                .attr('value', d => d)
                .text(d => d);

            // Set initial dropdown values
            questionDropdown.property('value', 1);
            emailDropdown.property('value', 'All');

            const plotData = (questionId, highlightedUsername) => {
                const plotDiv = d3.select('#plot');
                plotDiv.html(''); // Clear previous plot(s)

                const questionsToPlot = (questionId === 'all') ? events : events.filter(e => e.id == questionId);

                questionsToPlot.forEach(event => {
                    const questionData = responses.map(r => +r[event.id]);
                    const allUsernames = responses.map(r => r.Username);

                    let plotContainer;
                    if (questionId === 'all') {
                        const row = plotDiv.append('div').style('display', 'flex').style('align-items', 'center');
                        row.append('div').style('width', '300px').text(event.short);
                        plotContainer = row.append('div').attr('id', 'plot-' + event.id).style('width', 'calc(100% - 300px)');
                    } else {
                        // For a single plot, we can just use the main plot div.
                        plotContainer = plotDiv.append('div').attr('id', 'plot-single');
                    }

                    const trace1 = {
                        x: questionData,
                        type: 'violin',
                        name: ' ',
                        orientation: 'h',
                        hoverinfo: 'none',
                        box: { visible: false },
                        meanline: { visible: true },
                        side: 'positive',
                        fillcolor: 'rgba(0, 128, 0, 0.1)',
                        line: {
                            color: 'green'
                        }
                    };

                    const colors = allUsernames.map(u => u === highlightedUsername ? 'rgba(255, 0, 0, 0.7)' : 'rgba(0, 0, 255, 0.3)');

                    const trace2 = {
                        x: questionData,
                        y: Array(questionData.length).fill(' '),
                        type: 'scatter',
                        mode: 'markers',
                        text: allUsernames,
                        hovertemplate: '%{text}<extra></extra>',
                        marker: {
                            size: 10,
                            color: colors
                        }
                    };

                    const layout = {
                        showlegend: false,
                        xaxis: { range: [0, 1] },
                    };

                    if (questionId !== 'all') {
                        layout.title = event.short;
                        d3.select('#question-description').text(event.precise);
                    } else {
                        layout.margin = { l: 20, r: 20, b: 20, t: 20 };
                        layout.height = 100;
                        d3.select('#question-description').text('');
                    }

                    Plotly.newPlot(plotContainer.attr('id'), [trace1, trace2], layout);

                    document.getElementById(plotContainer.attr('id')).on('plotly_click', function (data) {
                        if (data.points.length > 0) {
                            const point = data.points[0];
                            if (point.curveNumber === 1) { // scatter plot trace
                                const username = point.text;
                                emailDropdown.property('value', username);
                                plotData(questionDropdown.property('value'), username);
                            }
                        }
                    });
                });
            };

            questionDropdown.on('change', function () {
                plotData(this.value, emailDropdown.property('value'));
            });

            emailDropdown.on('change', function () {
                plotData(questionDropdown.property('value'), this.value);
            });

            // Initial plot
            plotData(questionDropdown.property('value'), emailDropdown.property('value'));
        });
    </script>
</body>

</html>